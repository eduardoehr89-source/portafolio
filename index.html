<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Portafolio BIM de Said Herrera. Gesti√≥n de datos 6D y Coordinaci√≥n T√©cnica.">
    <title>SYSTEM_ONLINE // SAID HERRERA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           ESTILO CORE - TECH DASHBOARD THEME
           ========================================= */
        :root {
            --bg-dark: #0b1016;       
            --bg-panel: #151b26;      
            --bg-panel-transparent: rgba(21, 27, 38, 0.85);
            --accent-cyan: #22d3ee;   
            --accent-dim: #0e7490;    
            --text-main: #f1f5f9;     
            --text-muted: #94a3b8;    
            --text-inverse: #0b1016;
            --grid-line: rgba(34, 211, 238, 0.03);
            --border-color: rgba(34, 211, 238, 0.15);
            --map-fill: #1e293b;
            --map-stroke: #334155;
            --card-shadow: 0 0 20px rgba(34, 211, 238, 0.05);
            --radius-box: 12px;
        }

        body.light-mode {
            --bg-dark: #f0f4f8;       
            --bg-panel: #ffffff;      
            --bg-panel-transparent: rgba(255, 255, 255, 0.95);
            --accent-cyan: #0891b2;   
            --accent-dim: #cbd5e1;    
            --text-main: #1e293b;     
            --text-muted: #64748b;    
            --text-inverse: #ffffff;
            --grid-line: rgba(8, 145, 178, 0.05);
            --border-color: rgba(148, 163, 184, 0.3);
            --map-fill: #cbd5e1;
            --map-stroke: #ffffff;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 40px 40px;
            scroll-behavior: smooth;
            margin-bottom: 100px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .font-tech { font-family: 'JetBrains Mono', monospace; }
        
        .text-cyan { color: var(--accent-cyan); }
        .text-glow { text-shadow: 0 0 10px rgba(34, 211, 238, 0.4); }
        body.light-mode .text-glow { text-shadow: none; }

        .section-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: -1rem;
            margin-bottom: 2rem;
            max-width: 100%;
            white-space: nowrap;      
            overflow: hidden;         
            text-overflow: ellipsis;  
            border-left: 2px solid var(--accent-cyan);
            padding-left: 1rem;
        }

        .tech-card {
            background-color: var(--bg-panel-transparent);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-box);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        .tech-card:hover { border-color: var(--accent-cyan); }

        .btn-tech-primary {
            background-color: var(--accent-cyan);
            color: var(--text-inverse);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .btn-tech-primary:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }

        .btn-tech-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        
        .btn-tech-outline.active, 
        .view-btn.active {
            border-color: var(--accent-cyan);
            background-color: var(--accent-cyan) !important;
            color: var(--text-inverse) !important;
            font-weight: 700;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.3);
        }
        
        .btn-tech-outline:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .section-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; }
        .section-header i { color: var(--accent-cyan); }
        .section-title { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.25rem; color: var(--accent-cyan); letter-spacing: -0.05em; }

        .hero-stat-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); padding: 1rem; border-radius: 0.5rem; text-align: right; min-width: 140px; }
        body.light-mode .hero-stat-box { background: rgba(0,0,0,0.03); }
        .hero-stat-num { font-size: 2.5rem; font-weight: 900; line-height: 1; color: var(--text-main); }
        .hero-stat-label { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; display: block; }

        .map-wrapper { position: relative; height: 500px; width: 100%; background: var(--bg-panel); border-radius: var(--radius-box); overflow: hidden; border: 1px solid var(--border-color); }
        .city-marker { transition: r 0.3s ease, fill 0.3s ease; cursor: pointer; stroke: none; }
        .city-marker:hover { r: 6px; stroke: var(--text-main); stroke-width: 1px; }
        .country { fill: var(--map-fill); stroke: var(--map-stroke); stroke-width: 0.5px; transition: fill 0.3s ease; }
        .country-label-text { font-family: 'JetBrains Mono', sans-serif; font-weight: 900; font-size: 14px; fill: var(--text-muted); opacity: 0.5; pointer-events: none; letter-spacing: 0.2em; }
        
        .map-legend-overlay { position: absolute; bottom: 20px; left: 20px; background: var(--bg-panel); border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        #map-tooltip { position: fixed; top: 0; left: 0; z-index: 9999; pointer-events: auto; opacity: 0; visibility: hidden; transition: opacity 0.15s ease, visibility 0.15s ease; background: var(--bg-panel); backdrop-filter: blur(12px); border: 1px solid var(--border-color); color: var(--text-main); padding: 0; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: auto; max-width: 90vw; }
        .tooltip-header { font-weight: 800; font-size: 0.75rem; background: rgba(34, 211, 238, 0.05); border-bottom: 1px solid var(--border-color); padding: 8px 12px; text-transform: uppercase; font-family: 'JetBrains Mono', monospace; display: flex; justify-content: space-between; align-items: center; }
        .tooltip-content { padding: 4px; display: grid; grid-template-columns: 1fr; gap: 0; }
        .tooltip-cols-2 { grid-template-columns: repeat(2, 300px); }
        .tooltip-cols-3 { grid-template-columns: repeat(3, 300px); }
        .tooltip-row { display: grid; grid-template-columns: 40px 1fr; gap: 12px; padding: 6px 12px; cursor: pointer; transition: background 0.2s; align-items: center; border-bottom: 1px solid transparent; }
        .tooltip-row:hover { background: rgba(125,125,125,0.05); }
        .tooltip-pid { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; }
        .tooltip-info { display: flex; flex-direction: column; line-height: 1.2; }
        .tooltip-name { font-size: 0.75rem; font-weight: 600; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tooltip-meta { font-size: 0.65rem; color: var(--text-muted); font-family: 'Inter', sans-serif; }

        .controls-bar { background: var(--bg-panel); border: 1px solid var(--border-color); padding: 0.75rem; border-radius: var(--radius-box); display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; justify-content: space-between; }
        .search-input-tech { background: transparent; border: none; border-bottom: 1px solid var(--border-color); color: var(--text-main); padding: 4px 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; width: 200px; outline: none; transition: 0.3s; }
        .search-input-tech:focus { border-color: var(--accent-cyan); }

        #status-bar-container {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            animation: fadeIn 0.5s ease;
            text-align: right;
        }

        #list-view-wrapper { height: 500px; max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-box); background: var(--bg-panel); }
        .tech-table-grid { display: grid; grid-template-columns: 50px 15% 20% 8% 10% 12% 1fr; gap: 1rem; align-items: start; }
        .tech-table-header { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--accent-cyan); text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 8px; background: var(--bg-panel); position: sticky; top: 0; z-index: 10; padding-top: 8px; padding-left: 8px; }
        .tech-list-row { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); transition: 0.2s; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-main); }
        .tech-list-row div { white-space: normal; word-wrap: break-word; }
        .tech-list-row:hover { background: rgba(34, 211, 238, 0.05); padding-left: 12px; border-left: 2px solid var(--accent-cyan); }
        
        .project-card-tech { display: flex; flex-direction: column; background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: var(--radius-box); overflow: hidden; height: 500px; min-height: 500px; }
        @media (min-width: 1024px) { .project-card-tech { flex-direction: row; } }
        .p-info-side { padding: 2rem; width: 100%; display: flex; flex-direction: column; gap: 1rem; position: relative; overflow-y: auto; }
        .p-img-side { width: 100%; height: 100%; background: #0f172a; position: relative; display: flex; align-items: center; justify-content: center; border-left: 1px solid var(--border-color); }
        @media (min-width: 1024px) { .p-info-side { width: 40%; } .p-img-side { width: 60%; } }
        
        .field-label { font-family: 'JetBrains Mono', monospace; color: var(--accent-cyan); font-size: 0.7rem; margin-bottom: 2px; display: block; }
        .field-value { font-family: 'JetBrains Mono', monospace; color: var(--text-muted); font-size: 0.8rem; line-height: 1.5; }

        #gallery-view-wrapper { height: 500px; max-height: 500px; overflow-y: auto; padding-right: 8px; border: 1px solid transparent; }
        .gallery-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; }
        @media (min-width: 768px) { .gallery-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .gallery-grid { grid-template-columns: repeat(3, 1fr); } }
        .gallery-card { height: 240px; background-color: var(--bg-panel); background-size: cover; background-position: center; border-radius: 0.5rem; position: relative; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s ease; cursor: pointer; }
        .gallery-card:hover { transform: scale(1.02); border-color: var(--accent-cyan); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .gallery-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(11, 16, 22, 0.95), rgba(11, 16, 22, 0.5), transparent); padding: 1.5rem 1rem 1rem 1rem; display: flex; flex-direction: column; gap: 0.25rem; }
        
        .gallery-id { font-family: 'JetBrains Mono', monospace; color: #FFFFFF; font-size: 0.65rem; font-weight: 700; }
        .gallery-title { font-family: 'Inter', sans-serif; font-weight: 800; color: #FFFFFF; font-size: 1.1rem; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .gallery-loc { font-family: 'JetBrains Mono', monospace; color: #FFFFFF; font-size: 0.75rem; font-weight: 300; display: flex; align-items: center; gap: 4px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        .dock-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-panel-transparent); backdrop-filter: blur(12px); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: var(--radius-box); display: flex; gap: 8px; z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .dock-item { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 50px; border-radius: 8px; color: var(--text-muted); font-size: 0.6rem; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .dock-item:hover { color: var(--text-main); background: rgba(125,125,125,0.1); }
        .dock-item.active { color: var(--accent-cyan); background: rgba(34, 211, 238, 0.1); }
        
        .dock-item.highlight-cv { color: var(--accent-cyan); font-weight: 700; }
        .dock-item.highlight-cv:hover { text-shadow: 0 0 10px rgba(34, 211, 238, 0.6); }

        #chat-window { background: var(--bg-panel); border: 1px solid var(--border-color); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.3); border-radius: 12px; }
        #chat-header { background: transparent; border-bottom: 1px solid var(--border-color); padding: 12px 16px; }
        .bot-msg { background: rgba(34, 211, 238, 0.08); border-left: 2px solid var(--accent-cyan); color: var(--text-main); border-radius: 0 8px 8px 0; }
        .user-msg { background: rgba(148, 163, 184, 0.1); border-right: 2px solid var(--text-muted); color: var(--text-main); text-align: right; border-radius: 8px 0 0 8px; }
        #chat-input { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }
        #chat-footer { background: transparent; border-top: 1px solid var(--border-color); }
        #chat-launcher { background: var(--bg-panel); border: 1px solid var(--accent-cyan); color: var(--accent-cyan); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(34, 211, 238, 0.2); transition: 0.3s; }
        #chat-launcher:hover { transform: scale(1.05); background: var(--accent-cyan); color: var(--bg-dark); }

        .filter-popup { background: var(--bg-panel); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; position: absolute; top: 100%; right: 0; z-index: 20; width: 300px; margin-top: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .filter-select-tech { width: 100%; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-main); padding: 4px; border-radius: 4px; font-size: 0.75rem; }
        
        .modal-bg { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border-color); color: var(--text-main); }

        .hidden { display: none !important; }
        .uppercase { text-transform: uppercase; }
        
    </style>
</head>
<body>

    <main class="max-w-7xl mx-auto px-4 md:px-8 pt-12 pb-24">
        
        <div class="tech-card p-8 md:p-12 mb-20 flex flex-col md:flex-row justify-between items-start md:items-center relative">
            <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-cyan-400"></div>
            <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-cyan-400"></div>

            <div class="z-10">
                <div class="flex items-center gap-2 mb-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="font-tech text-xs text-cyan-400 tracking-wider">PORTFOLIO V.2025</span>
                </div>
                <h1 class="text-6xl md:text-8xl font-black text-white leading-none tracking-tight mb-2" style="color: var(--text-main);">
                    SAID<br><span class="text-cyan-400">HERRERA</span>
                </h1>
                <p class="text-xl text-gray-400 max-w-xl mt-4 border-l-2 border-cyan-900 pl-4" style="color: var(--text-muted);">
                    <strong style="color: var(--text-main);">Modelador BIM Senior.</strong> Especialista en gesti√≥n de datos 6D, coordinaci√≥n t√©cnica y automatizaci√≥n de procesos.
                </p>
            </div>

            <div class="flex flex-col gap-4 mt-8 md:mt-0 z-10">
                <div class="hero-stat-box">
                    <span class="hero-stat-num" id="hero-stat-projects">0</span>
                    <span class="hero-stat-label">Proyectos</span>
                </div>
                <div class="hero-stat-box">
                    <span class="hero-stat-num text-cyan-400">10+</span>
                    <span class="hero-stat-label">A√±os Experiencia</span>
                </div>
                <div class="hero-stat-box">
                    <span class="hero-stat-num text-cyan-400" id="hero-stat-cities">0</span>
                    <span class="hero-stat-label">Ciudades</span>
                </div>
            </div>
            
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(circle, var(--accent-cyan) 1px, transparent 1px); background-size: 20px 20px;"></div>
        </div>

        <section id="analisis" class="mb-24 scroll-mt-24">
            <div class="section-header">
                <i data-lucide="globe" class="w-6 h-6"></i>
                <h2 class="section-title">01_GEO_DATA</h2>
            </div>
            <p class="section-desc">Visualizaci√≥n global interactiva de sedes y proyectos ejecutados.</p>
            
            <div class="map-wrapper relative">
                <div id="d3-map-svg-container" class="w-full h-full"><svg id="map-svg"></svg></div>
                
                <div class="map-legend-overlay">
                    <div class="flex items-center justify-between gap-4 mb-1 cursor-pointer hover:opacity-75 text-gray-400" style="color: var(--text-muted);" onclick="filterMap('Obra')">
                        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> OBRA (SITIO)</div>
                        <span id="pct-obra" class="font-bold" style="color: var(--text-main);">0%</span>
                    </div>
                    <div class="flex items-center justify-between gap-4 mb-1 cursor-pointer hover:opacity-75 text-gray-400" style="color: var(--text-muted);" onclick="filterMap('Oficina')">
                        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> OFICINA (REMOTO)</div>
                        <span id="pct-oficina" class="font-bold" style="color: var(--text-main);">0%</span>
                    </div>
                    <div class="flex items-center justify-between gap-4 cursor-pointer hover:opacity-75 text-gray-400" style="color: var(--text-muted);" onclick="filterMap('Internacional')">
                        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> INT'L</div>
                        <span id="pct-inter" class="font-bold" style="color: var(--text-main);">0%</span>
                    </div>
                    <button id="reset-map-btn" class="mt-2 text-xs text-red-400 hover:text-red-300 w-full text-left" style="display:none;" onclick="event.stopPropagation(); filterMap('all')">[x] RESET VISTA</button>
                </div>
                
                <button class="absolute top-4 right-4 p-2 bg-black/20 border border-gray-500/30 hover:bg-cyan-500/20 hover:text-cyan-400 rounded text-white transition z-20" onclick="handleResetZoom()" aria-label="Reset Map Zoom">
                    <i data-lucide="minimize" class="w-5 h-5"></i>
                </button>

                <div id="map-stats-container" class="hidden absolute top-4 left-4 bg-black/80 p-2 border border-slate-700 rounded text-center z-10">
                    <div class="text-2xl font-bold text-white" id="stat-count-projects">0</div>
                    <div class="text-[0.6rem] text-gray-400 font-mono">PROYECTOS VISIBLES</div>
                </div>
            </div>
        </section>

        <section id="tipologia" class="mb-24 scroll-mt-24">
            <div class="section-header">
                <i data-lucide="activity" class="w-6 h-6"></i>
                <h2 class="section-title">02_ANALYTICS</h2>
            </div>
            <p class="section-desc">An√°lisis cuantitativo de la distribuci√≥n del portafolio por tipolog√≠a.</p>
            
            <div class="tech-card p-6 mb-8">
                <h3 class="font-tech text-xs text-gray-500 uppercase mb-4 tracking-widest">Tipolog√≠a de Proyecto</h3>
                <div id="typology-grid" class="flex flex-wrap gap-3"></div>
            </div>
        </section>

        <section id="tech-value" class="mb-24 scroll-mt-24">
            <div class="section-header">
                <i data-lucide="zap" class="w-6 h-6"></i>
                <h2 class="section-title">03_TECH_VALUE</h2>
            </div>
            <p class="section-desc">Soluciones BIM aplicadas a la gesti√≥n t√©cnica y reducci√≥n de riesgos.</p>
            
            <div class="tech-card p-6">
                <div id="tech-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
            </div>
        </section>

        <section id="proyectos" class="mb-24 scroll-mt-24">
            <div class="section-header justify-between">
                <div class="flex items-center gap-2">
                    <i data-lucide="folder-open" class="w-6 h-6"></i>
                    <h2 class="section-title">04_PROJECT_DB</h2>
                </div>
                <div class="controls-bar relative">
                    <div class="flex items-center gap-2">
                        <i data-lucide="search" class="w-4 h-4" style="color:var(--text-muted)"></i>
                        <input type="text" id="search-bar" class="search-input-tech" placeholder="Buscar ID, nombre..." onkeyup="runFilter('proyectos')">
                    </div>
                    
                    <div class="h-4 w-px bg-gray-700 mx-2 hidden md:block opacity-30"></div>

                    <div class="flex items-center gap-2">
                        <button id="btn-top5" class="btn-tech-outline px-3 py-1 rounded text-xs font-bold active" onclick="toggleTop5()">TOP 5</button>
                        
                        <div class="relative">
                            <button id="btn-filter-toggle" class="btn-tech-outline px-2 py-1 rounded" onclick="toggleFilters('proyectos')">
                                <i data-lucide="filter" class="w-4 h-4"></i>
                            </button>
                            <div id="proyectos-filters" class="filter-popup hidden">
                                <h4 class="font-tech text-xs text-cyan-400 mb-3 border-b border-gray-700 pb-2">FILTROS AVANZADOS</h4>
                                <div class="grid grid-cols-1 gap-3">
                                    <div><label class="text-[0.65rem] font-mono block mb-1" style="color:var(--text-muted)">FASE</label><select id="proyectos-filter-fase" class="filter-select-tech" onchange="runFilter('proyectos')"><option value="all">TODAS</option></select></div>
                                    <div><label class="text-[0.65rem] font-mono block mb-1" style="color:var(--text-muted)">TIPOLOG√çA</label><select id="proyectos-filter-type" class="filter-select-tech" onchange="runFilter('proyectos')"><option value="all">TODAS</option></select></div>
                                    <div><label class="text-[0.65rem] font-mono block mb-1" style="color:var(--text-muted)">DISCIPLINA</label><select id="proyectos-filter-disc" class="filter-select-tech" onchange="runFilter('proyectos')"><option value="all">TODAS</option></select></div>
                                    <div><label class="text-[0.65rem] font-mono block mb-1" style="color:var(--text-muted)">A√ëO</label><select id="proyectos-filter-year" class="filter-select-tech" onchange="runFilter('proyectos')"><option value="all">TODOS</option></select></div>
                                    <button class="w-full border border-red-500 text-red-500 text-xs py-1 mt-2 hover:bg-red-500 hover:text-white transition" onclick="clearFilters('proyectos')">LIMPIAR</button>
                                </div>
                            </div>
                        </div>

                        <select class="bg-transparent text-xs font-mono border-none outline-none cursor-pointer hover:text-cyan-400" style="color:var(--text-muted)" onchange="updateSort('proyectos', this.value)">
                            <option value="default">ORDEN: RECIENTE</option>
                            <option value="year_asc">ORDEN: ANTIGUO</option>
                            <option value="name_asc">ORDEN: A-Z</option>
                        </select>

                        <div class="flex bg-black/10 rounded p-1 gap-1 view-toggle-wrapper border border-white/5">
                            <button class="p-1 rounded hover:bg-white/10 text-gray-400 view-btn" onclick="setProjectView('proyectos', 'carousel')" title="Vista Ficha"><i data-lucide="rectangle-horizontal" class="w-3 h-3"></i></button>
                            <button class="p-1 rounded hover:bg-white/10 text-gray-400 view-btn" onclick="setProjectView('proyectos', 'gallery')" title="Vista Galer√≠a"><i data-lucide="layout-grid" class="w-3 h-3"></i></button>
                            <button class="p-1 rounded hover:bg-white/10 text-gray-400 view-btn active" onclick="setProjectView('proyectos', 'list')" title="Vista Lista"><i data-lucide="list" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center mb-6 pl-3 border-l border-cyan-900">
                <p class="section-desc-inline" style="font-size:0.85rem; color:var(--text-muted)">Base de datos completa con filtros din√°micos y fichas t√©cnicas.</p>
                <div id="status-bar-container"></div>
            </div>
            
            <p id="project-section-desc" class="hidden"></p>

            <div id="list-view-wrapper" class="block w-full overflow-x-auto">
                <div class="tech-table-header tech-table-grid min-w-[900px]">
                    <span>ID</span>
                    <span>PROYECTO</span>
                    <span>DESCRIPCI√ìN T√âCNICA</span>
                    <span>FASE</span>
                    <span>TIPO</span>
                    <span>DISCIPLINA</span>
                    <span>STACK</span>
                </div>
                <div id="proyectos-list-container" class="min-w-[900px]"></div>
            </div>

            <div id="carousel-view-wrapper" class="hidden">
                <div class="project-card-tech">
                    <div class="p-info-side" id="carousel-info-content"></div>
                    <div class="p-img-side" id="carousel-image-bg">
                        <div class="absolute inset-0 flex items-center justify-between px-4 z-20">
                            <button class="p-2 bg-black/50 hover:bg-cyan-500 hover:text-black text-white rounded-full transition" onclick="navigateCarouselImage(-1)"><i data-lucide="chevron-left"></i></button>
                            <button class="p-2 bg-black/50 hover:bg-cyan-500 hover:text-black text-white rounded-full transition" onclick="navigateCarouselImage(1)"><i data-lucide="chevron-right"></i></button>
                        </div>
                        <div class="font-black text-6xl text-white/5 select-none" id="carousel-img-text">IMG</div>
                        <div class="absolute bottom-4 right-4 bg-black/70 text-white text-xs px-2 py-1 rounded font-mono" id="carousel-img-count">1 / 3</div>
                    </div>
                </div>
            </div>

            <div id="gallery-view-wrapper" class="hidden">
                <div id="gallery-grid-container" class="gallery-grid"></div>
            </div>

        </section>

        <section id="software" class="mb-24 scroll-mt-24">
            <div class="section-header">
                <i data-lucide="cpu" class="w-6 h-6"></i>
                <h2 class="section-title">05_STACK</h2>
            </div>
            <p class="section-desc">Ecosistema digital. Integro <b>Gemini AI</b> como asistente de apoyo para mejorar el flujo de trabajo global.</p>
            
            <div id="software-list" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            
            <div class="mt-12 text-center">
                <p class="font-mono text-xs text-gray-500 mb-4">APRENDIZAJE CONTINUO // MASTER BIM + IA</p>
                <button class="btn-tech-outline px-8 py-3 rounded-full border-gray-600 hover:border-cyan-400" style="color:var(--text-main)">
                    <i data-lucide="file-text" class="w-4 h-4 mr-2 inline"></i> VER PROGRAMA ACAD√âMICO
                </button>
            </div>
        </section>

        <div id="discipline-grid" class="hidden"></div> 

    </main>

    <footer class="w-full text-center py-6 border-t border-gray-800 mt-12 mb-24">
        <p class="font-mono text-xs text-gray-500">
            POWERED BY <span class="text-cyan-600 font-bold">GEMINI PRO</span> & <span class="text-cyan-600 font-bold">ANTIGRAVITY</span>
        </p>
    </footer>

    <nav class="dock-nav">
        <a href="#analisis" class="dock-item" title="Geo Data"><i data-lucide="globe"></i> GEO</a>
        <a href="#tipologia" class="dock-item" title="Analytics"><i data-lucide="bar-chart-2"></i> DATA</a>
        <a href="#tech-value" class="dock-item" title="Valor T√©cnico"><i data-lucide="zap"></i> TECH</a>
        <a href="#proyectos" class="dock-item" title="Proyectos"><i data-lucide="folder"></i> PROJ</a>
        <a href="#software" class="dock-item" title="Stack"><i data-lucide="cpu"></i> STACK</a>
        <div class="w-px h-6 bg-gray-700 mx-1"></div>
        <button class="dock-item" onclick="toggleTheme()" title="Cambiar Tema"><i data-lucide="sun"></i> TEMA</button>
        <a href="#" class="dock-item highlight-cv" title="CV Download"><i data-lucide="file-text"></i> CV</a>
    </nav>

    <div id="bim-assistant-container" class="fixed bottom-24 right-6 flex flex-col items-end z-50">
        <div id="proactive-tooltip" class="mb-2 bg-slate-800 border border-cyan-500/50 text-white p-3 rounded-lg text-xs w-56 shadow-lg transform translate-y-4 opacity-0 transition-all duration-300 pointer-events-none" onclick="triggerAssistantSpecial()">
            <div class="flex items-start gap-2">
                <span class="text-lg">ü§ñ</span>
                <div>
                    <strong class="text-cyan-400 block mb-1">SYSTEM ALERT</strong>
                    Said cursa un M√°ster en BIM + IA. ¬øTe explico c√≥mo beneficia esto a tu proyecto?
                </div>
            </div>
        </div>

        <div id="chat-window" class="hidden mb-4 w-80 h-[500px] flex flex-col overflow-hidden transition-all duration-300" onclick="event.stopPropagation()">
            <div id="chat-header" class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="font-tech text-xs text-cyan-400 font-bold">AI_ASSISTANT_V1</span>
                </div>
                <button onclick="toggleChat()" class="text-gray-400 hover:text-cyan-400"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-3 text-sm font-mono scrollbar-thin scrollbar-thumb-gray-700"></div>
            <div id="chat-options" class="p-2 grid grid-cols-1 gap-1 border-t border-dashed" style="border-color:var(--border-color)"></div>
            <div id="chat-footer" class="p-3">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-1 rounded px-2 py-1 text-xs outline-none focus:border-cyan-400 font-mono" placeholder="Escriba comando..." onkeypress="handleEnter(event)">
                    <button id="chat-send-btn" class="bg-cyan-500 text-white p-1 rounded hover:bg-cyan-400" onclick="handleInput()"><i data-lucide="send" class="w-4 h-4"></i></button>
                </div>
                <div class="flex justify-between mt-2 px-1">
                    <button id="nav-back" class="text-gray-500 hover:text-cyan-400 disabled:opacity-30" onclick="goBack()"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                    <button onclick="resetChat()" class="text-gray-500 hover:text-cyan-400"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div id="toast-notification" class="absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-green-600 text-white text-xs py-1 px-3 rounded-full opacity-0 transition">Comando Copiado</div>
        </div>

        <button id="chat-launcher" onclick="toggleChat()" aria-label="Abrir Terminal">
            <i data-lucide="bot" class="w-6 h-6"></i>
        </button>
    </div>

    <div id="gallery-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-bg opacity-0 transition-opacity duration-300">
        <div class="modal-content relative w-[95%] max-w-6xl modal-box rounded-lg shadow-2xl flex flex-col max-h-[90vh] overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="p-4 border-b flex justify-between items-center bg-black/20" style="border-color:var(--border-color)">
                <div id="modal-header" class="flex items-center gap-4 overflow-hidden">
                    <div id="modal-title-container" class="flex items-baseline gap-2"></div>
                </div>
                <div class="flex gap-2">
                    <button class="p-2 hover:bg-white/10 rounded" style="color:var(--text-main)" onclick="navigateProject(-1)"><i data-lucide="chevron-left"></i></button>
                    <button class="p-2 hover:bg-white/10 rounded" style="color:var(--text-main)" onclick="navigateProject(1)"><i data-lucide="chevron-right"></i></button>
                    <button class="p-2 hover:bg-red-500/20 text-red-400 hover:text-red-200 rounded" onclick="closeGallery()"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div class="modal-image-container relative flex-1 bg-black flex items-center justify-center min-h-[400px]">
                <div id="modal-img-bg" class="absolute inset-0 bg-contain bg-center bg-no-repeat transition-all duration-300"></div>
                <div class="img-counter absolute bottom-4 right-4 bg-black/60 text-white text-xs px-2 py-1 rounded font-mono" id="modal-counter">1 / 5</div>
                <button class="img-nav-btn absolute left-4 p-3 bg-black/50 hover:bg-cyan-500 hover:text-black rounded-full text-white transition z-10" onclick="navigateImage(-1)"><i data-lucide="chevron-left"></i></button>
                <button class="img-nav-btn absolute right-4 p-3 bg-black/50 hover:bg-cyan-500 hover:text-black rounded-full text-white transition z-10" onclick="navigateImage(1)"><i data-lucide="chevron-right"></i></button>
            </div>
        </div>
    </div>
    
    <div id="map-tooltip" class="fixed z-[9999] opacity-0 invisible transition-opacity duration-200 text-xs pointer-events-none"></div>

    <script>
        const stdSoftware = "AutoCAD, BIM 360, Monday.com, Navisworks, Revit, Twinmotion";
        
        // --- BASE DE DATOS FINAL (RE-NUMERADA CRONOL√ìGICAMENTE) ---
        const projectsDB = {
            // 2014
            P01: { name: "Estadio BBVA", year: "2014", fase: "Obra", tipologia: "OTROS", rol: "Modelador BIM JR", desafio: "Levantamiento geom√©trico...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Jefe de Control, Seguridad", disciplinas: "Estructura", software: stdSoftware, coords: [-100.22, 25.65] },
            // 2017
            P02: { name: "Proyectos Vivienda", year: "2017-2022", fase: "Obra", tipologia: "VIVIENDA", rol: "Modelador BIM JR", desafio: "Levantamiento As-Built...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Arquitectura ‚Ä¢ Estructura", software: stdSoftware, coords: [-100.31, 25.68] },
            P03: { name: "Torre KOI", year: "2017", fase: "Obra", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM JR", desafio: "Validaci√≥n volumetr√≠a...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "MEP", software: stdSoftware, coords: [-100.38, 25.65] },
            // 2018
            P04: { name: "Escuela Secundaria TX", year: "2018", fase: "Oficina", tipologia: "OTROS", rol: "Modelador BIM JR", desafio: "Modelado estructura...", ubicacion: "Austin, TX, USA", comunicacion: "BIM Manager, Cliente", disciplinas: "Estructura ‚Ä¢ Acero", software: stdSoftware, coords: [-97.74, 30.26] },
            P05: { name: "Nave Industrial AZ", year: "2018", fase: "Oficina", tipologia: "OTROS", rol: "Modelador BIM JR", desafio: "Detallado conexiones...", ubicacion: "Phoenix, AZ, USA", comunicacion: "BIM Manager, Cliente", disciplinas: "Estructura ‚Ä¢ Acero", software: stdSoftware, coords: [-112.07, 33.44] },
            // 2019
            P06: { name: "Casa Herrera", year: "2019", fase: "Obra", tipologia: "VIVIENDA", rol: "Modelador BIM JR", desafio: "Dise√±o ampliaci√≥n...", ubicacion: "R√≠o Grande, Zac.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Arquitectura", software: stdSoftware, coords: [-103.01, 23.83] },
            // 2022 (Centrales Mezclas & COVID)
            P07: { name: "Central de Mezclas", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Auditor√≠a 5D...", ubicacion: "CDMX", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura ‚Ä¢ Estructura ‚Ä¢ MEP", software: stdSoftware, coords: [-99.14, 19.46] },
            P08: { name: "Central de Mezclas", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Modelado estructural...", ubicacion: "Cd. Ju√°rez, Chih.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura ‚Ä¢ Estructura ‚Ä¢ MEP", software: stdSoftware, coords: [-106.48, 31.76] },
            P09: { name: "Central de Mezclas", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Coordinaci√≥n MEP...", ubicacion: "Guadalajara, Jal.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura ‚Ä¢ Estructura ‚Ä¢ MEP", software: stdSoftware, coords: [-103.34, 20.65] },
            P10: { name: "Central de Mezclas", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Extracci√≥n planos...", ubicacion: "San Quint√≠n, B.C.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura ‚Ä¢ General", software: stdSoftware, coords: [-115.95, 30.43] },
            P11: { name: "Central de Mezclas", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Documentaci√≥n...", ubicacion: "Tampico, Tamps.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura ‚Ä¢ Estructura ‚Ä¢ MEP", software: stdSoftware, coords: [-97.85, 22.25] },
            P12: { name: "Central de Mezclas", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Modelado...", ubicacion: "Tijuana, B.C.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura ‚Ä¢ Estructura ‚Ä¢ MEP", software: stdSoftware, coords: [-117.03, 32.51] },
            // M√≥dulos COVID (2022) - Reordenados P13-P38
            P13: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Agua Prieta, Son.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-109.55, 31.33] },
            P14: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Agua Prieta, Son.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-109.56, 31.34] },
            P15: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Cd. Ju√°rez, Chih.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-106.42, 31.69] },
            P16: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Cd. Obreg√≥n, Son.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-109.93, 27.48] },
            P17: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Culiac√°n, Sin.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-107.39, 24.80] },
            P18: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Fresnillo, Zac.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-102.86, 23.17] },
            P19: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Mexicali, B.C.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-115.45, 32.62] },
            P20: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Mexicali, B.C.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-115.46, 32.63] },
            P21: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Monclova, Coah.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-101.41, 26.90] },
            P22: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Monclova, Coah.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-101.42, 26.91] },
            P23: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Monterrey, N.L.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-100.31, 25.68] },
            P24: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Monterrey, N.L.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-100.32, 25.68] },
            P25: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Puebla, Pue.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-98.20, 19.04] },
            P26: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Quer√©taro, Qro.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-100.38, 20.58] },
            P27: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Saltillo, Coah.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-101.00, 25.42] },
            P28: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Saltillo, Coah.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-101.01, 25.43] },
            P29: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "San Jos√© del Cabo, BCS", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-109.70, 23.06] },
            P30: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "San Jos√© del Cabo, BCS", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-109.71, 23.07] },
            P31: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "San Luis Potos√≠", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-100.98, 22.15] },
            P32: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "San Luis Potos√≠", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-100.99, 22.16] },
            P33: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "San Quint√≠n, B.C.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-115.93, 30.48] },
            P34: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Tlalnepantla, Edo. M√©x.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-99.19, 19.54] },
            P35: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Tuxtla Gtz, Chis.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-93.11, 16.75] },
            P36: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Villahermosa, Tab.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-92.92, 17.98] },
            P37: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Zamora, Mich.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-102.28, 19.98] },
            P38: { name: "M√≥dulo COVID", year: "2022", fase: "Oficina", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Dise√±o acelerado...", ubicacion: "Zamora, Mich.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-102.29, 19.99] },
            // 2023
            P39: { name: "Central de Mezclas", year: "2023", fase: "Obra", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Auditor√≠a 5D...", ubicacion: "Torre√≥n, Coah.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Arquitectura ‚Ä¢ Estructura ‚Ä¢ MEP", software: stdSoftware, coords: [-103.40, 25.54] },
            P40: { name: "Puentes Libramiento", year: "2023", fase: "Obra", tipologia: "INFRAESTRUCTURA", rol: "Modelador BIM JR", desafio: "Modelado nubes...", ubicacion: "Edo. M√©x.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Infraestructura", software: stdSoftware, coords: [-99.50, 19.50] },
            P41: { name: "Salina Cruz", year: "2023", fase: "Oficina", tipologia: "VIVIENDA", rol: "Modelador BIM JR", desafio: "Coordinaci√≥n...", ubicacion: "Salina Cruz, Oax.", comunicacion: "BIM Manager, Cliente", disciplinas: "Estructura ‚Ä¢ MEP", software: stdSoftware, coords: [-95.20, 16.16] },
            P42: { name: "Sal√≥n Hern√°ndez", year: "2023", fase: "Oficina", tipologia: "OTROS", rol: "Modelador BIM JR", desafio: "Remodelaci√≥n...", ubicacion: "Orizaba, Ver.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura", software: stdSoftware, coords: [-97.10, 18.84] },
            // 2024
            P43: { name: "Aeropuerto Norman Manley", year: "2024", fase: "Oficina", tipologia: "INFRAESTRUCTURA", rol: "Modelador BIM SR", desafio: "Precisi√≥n...", ubicacion: "Kingston, Jamaica", comunicacion: "BIM Manager, Cliente", disciplinas: "Confidencial", software: stdSoftware, coords: [-76.79, 17.97] },
            P44: { name: "Aldaba", year: "2024", fase: "Obra", tipologia: "VIVIENDA", rol: "Modelador BIM SR", desafio: "Creaci√≥n de la documentaci√≥n.", ubicacion: "Le√≥n, Gto.", comunicacion: "Modelador", disciplinas: "Arquitectura", software: stdSoftware, coords: [-101.68, 21.12] },
            P45: { name: "Aulas X (Fase 1)", year: "2024", fase: "Oficina", tipologia: "OTROS", rol: "Modelador BIM SR", desafio: "Documentaci√≥n...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura", software: stdSoftware, coords: [-100.31, 25.68] },
            P46: { name: "Barrio W", year: "2024", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Creaci√≥n de la documentaci√≥n.", ubicacion: "Monterrey, N.L.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-100.30, 25.67] },
            P47: { name: "Bubledeck", year: "2024", fase: "Obra", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Liderazgo...", ubicacion: "Edo. M√©x.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Estructura", software: stdSoftware, coords: [-99.50, 19.50] },
            P48: { name: "Carretera San Miguel", year: "2024", fase: "Obra", tipologia: "INFRAESTRUCTURA", rol: "Modelador BIM SR", desafio: "Optimizaci√≥n...", ubicacion: "San Miguel, GTO", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Infraestructura", software: stdSoftware, coords: [-100.74, 20.91] },
            P49: { name: "Casa Cerro Abanico", year: "2024", fase: "Obra", tipologia: "VIVIENDA", rol: "Modelador BIM SR", desafio: "Creaci√≥n de la documentaci√≥n.", ubicacion: "CDMX", comunicacion: "Modelador", disciplinas: "Arquitectura", software: stdSoftware, coords: [-99.13, 19.43] },
            P50: { name: "Distrito Rep√∫blica", year: "2024", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Creaci√≥n de la documentaci√≥n.", ubicacion: "Guadalajara, Jal.", comunicacion: "Modelador", disciplinas: "MEP", software: stdSoftware, coords: [-103.34, 20.65] },
            P51: { name: "Esplendor II", year: "2024", fase: "Oficina", tipologia: "VIVIENDA", rol: "Modelador BIM SR", desafio: "Creaci√≥n de la documentaci√≥n.", ubicacion: "Nacajuca, Tab.", comunicacion: "Modelador", disciplinas: "Arquitectura ‚Ä¢ Estructura", software: stdSoftware, coords: [-93.01, 18.14] },
            P52: { name: "Hospital General de Zona", year: "2024", fase: "Obra", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Modelado...", ubicacion: "Tula, Hgo.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Arquitectura ‚Ä¢ Estructura", software: stdSoftware, coords: [-99.34, 20.05] },
            P53: { name: "Metrob√∫s L√≠nea 3", year: "2024", fase: "Obra", tipologia: "INFRAESTRUCTURA", rol: "Modelador BIM SR", desafio: "Creaci√≥n de la documentaci√≥n.", ubicacion: "CDMX", comunicacion: "Modelador", disciplinas: "Infraestructura", software: stdSoftware, coords: [-99.13, 19.43] },
            P54: { name: "Proyecto Seguridad", year: "2024", fase: "Obra", tipologia: "SEGURIDAD", rol: "Modelador BIM SR", desafio: "Confidencial", ubicacion: "Confidencial", comunicacion: "Confidencial", disciplinas: "Confidencial", software: stdSoftware, coords: [-98.00, 21.50], isConfidential: true },
            P55: { name: "Puentes Perif√©ricos", year: "2024", fase: "Obra", tipologia: "INFRAESTRUCTURA", rol: "Modelador BIM SR", desafio: "Reconstrucci√≥n...", ubicacion: "Edo. M√©x.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Estructura", software: stdSoftware, coords: [-99.50, 19.50] },
            P56: { name: "Tawra", year: "2024", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Validaci√≥n...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "MEP", software: stdSoftware, coords: [-100.31, 25.68] },
            P57: { name: "Tren Ligero", year: "2024", fase: "Obra", tipologia: "INFRAESTRUCTURA", rol: "Modelador BIM SR", desafio: "Supervisi√≥n...", ubicacion: "Campeche, Camp.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Infraestructura", software: stdSoftware, coords: [-90.53, 19.83] },
            P58: { name: "Unidad de Medicina Familiar", year: "2024", fase: "Obra", tipologia: "SALUD", rol: "Modelador BIM SR", desafio: "Resoluci√≥n...", ubicacion: "Tula, Hgo.", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "MEP", software: stdSoftware, coords: [-99.34, 20.05] },
            // 2025
            P59: { name: "Aeropuerto Int. Canc√∫n", year: "2025", fase: "Oficina", tipologia: "INFRAESTRUCTURA", rol: "Modelador BIM SR", desafio: "Optimizaci√≥n...", ubicacion: "Canc√∫n, Q.Roo", comunicacion: "BIM Manager, Cliente", disciplinas: "Confidencial", software: stdSoftware, coords: [-86.85, 21.16] },
            P60: { name: "Akasia", year: "2025", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Tablas...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "MEP", software: stdSoftware, coords: [-100.31, 25.68] },
            P61: { name: "Aulas X", year: "2025", fase: "Oficina", tipologia: "EDUCACI√ìN", rol: "Modelador BIM SR", desafio: "Modelado estructural.", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "Estructura", software: stdSoftware, coords: [-100.31, 25.68] },
            P62: { name: "Belgica", year: "2025", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Coordinaci√≥n...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "MEP", software: stdSoftware, coords: [-100.31, 25.68] },
            P63: { name: "Barrio Santa Luc√≠a", year: "2025", fase: "Obra", tipologia: "VIVIENDA", rol: "Modelador BIM SR", desafio: "Coordinaci√≥n de acabados.", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura", software: stdSoftware, coords: [-100.31, 25.68], isTop: true },
            P64: { name: "Corporativo CEMEX", year: "2025", fase: "Obra", tipologia: "OTROS", rol: "Modelador BIM SR", desafio: "Optimizaci√≥n...", ubicacion: "CDMX", comunicacion: "BIM Manager, Jefe de Control", disciplinas: "Arquitectura", software: stdSoftware, coords: [-99.13, 19.43] },
            P65: { name: "Grazia", year: "2025", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Modelado...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "MEP", software: stdSoftware, coords: [-100.31, 25.68] },
            P66: { name: "Makmul", year: "2025", fase: "Oficina", tipologia: "VIVIENDA", rol: "Modelador BIM SR", desafio: "Soluci√≥n...", ubicacion: "Canc√∫n, Q.Roo", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura", software: stdSoftware, coords: [-86.85, 21.16] },
            P67: { name: "Medline", year: "2025", fase: "Oficina", tipologia: "INFRAESTRUCTURA", rol: "Modelador BIM SR", desafio: "Modelado...", ubicacion: "Nuevo Laredo, Tamps.", comunicacion: "BIM Manager, Cliente", disciplinas: "Infraestructura", software: stdSoftware, coords: [-99.51, 27.47] },
            P68: { name: "Mediterr√°neo", year: "2025", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Auditor√≠a...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "MEP", software: stdSoftware, coords: [-100.31, 25.68] },
            P69: { name: "Naomi", year: "2025", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Gesti√≥n...", ubicacion: "Canc√∫n, Q.Roo", comunicacion: "BIM Manager, Cliente", disciplinas: "MEP", software: stdSoftware, coords: [-86.85, 21.16] },
            P70: { name: "Residencias TEC", year: "2025", fase: "Oficina", tipologia: "VIVIENDA", rol: "Modelador BIM SR", desafio: "Coordinaci√≥n...", ubicacion: "Puebla, Pue.", comunicacion: "BIM Manager, Cliente", disciplinas: "Arquitectura", software: stdSoftware, coords: [-98.20, 19.04] },
            P71: { name: "Semillero", year: "2025", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Modelado...", ubicacion: "Monterrey, N.L.", comunicacion: "BIM Manager, Cliente", disciplinas: "MEP", software: stdSoftware, coords: [-100.31, 25.68] },
            P72: { name: "Zonna", year: "2025", fase: "Oficina", tipologia: "EDIFICACI√ìN", rol: "Modelador BIM SR", desafio: "Dise√±o...", ubicacion: "Canc√∫n, Q.Roo", comunicacion: "BIM Manager, Cliente", disciplinas: "MEP", software: stdSoftware, coords: [-86.85, 21.16] }
        };

        // ESTADO GLOBAL
        let sortedProjects = [];
        let currentFilters = { type: 'all', disc: 'all', year: 'all', fase: 'all' };
        let currentIdx = 0;
        let currentCarouselIdx = 0;
        let currentImageIdx = 1;
        let tooltipElement, hideTimeout, svg, g;
        
        // --- CAMBIO DE DEFAULT STATE ---
        let currentViewMode = 'list'; 
        let isTop5Active = true; 
        let chatHistory = []; 

        document.addEventListener('DOMContentLoaded', () => {
            initData();
            renderAll();
            populateFilterOptions();
            lucide.createIcons();
            
            tooltipElement = document.getElementById('map-tooltip');
            
            // --- INICIALIZACI√ìN POR DEFECTO (TOP 5 + LISTA) ---
            setProjectView('proyectos', 'list');
            toggleTop5(); // Activa el filtro Top 5 al inicio
            
            // Listeners globales
            document.addEventListener('click', (e) => {
                const filterPanel = document.getElementById('proyectos-filters');
                const filterBtn = document.querySelector('button[onclick="toggleFilters(\'proyectos\')"]');
                const filterToggleBtn = document.getElementById('btn-filter-toggle');
                
                if (filterPanel && !filterPanel.classList.contains('hidden')) {
                    if (!filterPanel.contains(e.target) && !filterBtn.contains(e.target) && !filterToggleBtn.contains(e.target)) {
                        filterPanel.classList.add('hidden');
                        if(currentFilters.type === 'all' && currentFilters.fase === 'all' && currentFilters.disc === 'all' && currentFilters.year === 'all') {
                             filterToggleBtn.classList.remove('active');
                        }
                    }
                }
                const chat = document.getElementById('chat-window');
                const launcher = document.getElementById('chat-launcher');
                const tooltip = document.getElementById('proactive-tooltip');
                if (!chat.classList.contains('hidden') && !chat.contains(e.target) && !launcher.contains(e.target) && !tooltip.contains(e.target)) toggleChat();
            });

            window.addEventListener('resize', () => {
                 const container = document.getElementById('d3-map-svg-container');
                 if(container && d3.select("#map-svg").node()) {
                     const w = container.clientWidth;
                     d3.select("#map-svg").attr("width", w);
                 }
            });
            
            animateValue("hero-stat-projects", 0, sortedProjects.length, 1500);
            const uniqueCities = new Set(sortedProjects.map(p => p.ubicacion.split(',')[0].trim())).size;
            animateValue("hero-stat-cities", 0, uniqueCities, 1500);

            setTimeout(() => {
                const tooltip = document.getElementById('proactive-tooltip');
                if(tooltip) {
                    tooltip.classList.remove('opacity-0', 'translate-y-4');
                    tooltip.classList.add('pointer-events-auto');
                    setTimeout(() => {
                        tooltip.classList.add('opacity-0', 'translate-y-4');
                    }, 8000);
                }
            }, 3000);
        });

        /* ================= LIGHT MODE LOGIC ================= */
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            const icon = document.querySelector('.dock-item[onclick="toggleTheme()"] i');
            
            if(isLight) {
                if(icon) { icon.setAttribute('data-lucide', 'moon'); lucide.createIcons(); }
            } else {
                if(icon) { icon.setAttribute('data-lucide', 'sun'); lucide.createIcons(); }
            }
        }

        /* ================= FUNCIONES DE RENDERIZADO ================= */

        function initData() {
            sortedProjects = Object.entries(projectsDB).map(([id, data]) => ({id, ...data}));
            const total = sortedProjects.length;
            const isInt = (p) => p.ubicacion.includes('USA') || p.ubicacion.includes('Jamaica');
            const countInter = sortedProjects.filter(p => isInt(p)).length;
            const countObra = sortedProjects.filter(p => p.fase === 'Obra' && !isInt(p)).length;
            const countOficina = sortedProjects.filter(p => p.fase === 'Oficina' && !isInt(p)).length;

            document.getElementById('pct-obra').innerText = Math.round((countObra / total) * 100) + '%';
            document.getElementById('pct-oficina').innerText = Math.round((countOficina / total) * 100) + '%';
            document.getElementById('pct-inter').innerText = Math.round((countInter / total) * 100) + '%';
        }

        function renderAll() {
            renderProjects('proyectos', sortedProjects);
            renderSoftware(); 
            generateTypologyStats(); 
            renderTech(); 
            renderD3Map();
        }

        function renderProjects(section, list) {
            window.currentFilteredList = list;
            if(currentViewMode === 'list') {
                renderListView(list);
            } else if(currentViewMode === 'gallery') {
                renderGalleryView(list);
            } else {
                renderCarouselView(list);
            }
        }

        function renderListView(list) {
            const container = document.getElementById('proyectos-list-container');
            const listWrapper = document.getElementById('list-view-wrapper');
            const carouselWrapper = document.getElementById('carousel-view-wrapper');
            const galleryWrapper = document.getElementById('gallery-view-wrapper');
            
            listWrapper.classList.remove('hidden');
            carouselWrapper.style.display = 'none';
            galleryWrapper.classList.add('hidden');

            if(list.length === 0) {
                container.innerHTML = `<div class="p-4 text-center text-gray-500 font-mono">NO DATA FOUND</div>`;
                return;
            }
            
            container.innerHTML = list.map(p => {
                const discTextList = p.disciplinas.includes('‚Ä¢') ? p.disciplinas.replace(/‚Ä¢/g, ', ') : p.disciplinas;
                return `
                <div class="tech-list-row grid grid-cols-[50px_15%_20%_8%_10%_12%_1fr] gap-4" onclick="openGallery('${p.id}')">
                    <div class="font-bold text-cyan-400">${p.id}</div>
                    <div>
                        <div class="font-bold text-sm" style="color:var(--text-main)">${p.name}</div>
                        <div class="text-[0.65rem] text-gray-400 uppercase">${p.ubicacion}</div>
                    </div>
                    <div class="opacity-80" style="color:var(--text-muted)">${p.desafio}</div>
                    <div><span class="bg-cyan-500/10 text-cyan-400 rounded px-2 py-1 text-center w-fit block font-normal">${p.fase}</span></div>
                    <div class="opacity-80" style="color:var(--text-muted)">${p.tipologia}</div>
                    <div class="text-[0.65rem] uppercase" style="color:var(--text-muted)">${discTextList}</div> <div class="text-[0.65rem] opacity-70" style="color:var(--text-muted)">${p.software}</div>
                </div>`;
            }).join('');
        }

        function renderGalleryView(list) {
            const listWrapper = document.getElementById('list-view-wrapper');
            const carouselWrapper = document.getElementById('carousel-view-wrapper');
            const galleryWrapper = document.getElementById('gallery-view-wrapper');
            const container = document.getElementById('gallery-grid-container');
            
            listWrapper.classList.add('hidden');
            carouselWrapper.style.display = 'none';
            galleryWrapper.classList.remove('hidden');

            if(list.length === 0) {
                container.innerHTML = `<div class="col-span-full p-4 text-center text-gray-500 font-mono">NO DATA FOUND</div>`;
                return;
            }

            container.innerHTML = list.map((p, idx) => {
                const rutaImagen = `img/${p.id} ${p.name}/1.jpg`;
                return `
                <div class="gallery-card group bg-gray-800 relative" 
                     style="background-image: url('${rutaImagen}'); background-size: cover; background-position: center;"
                     onclick="openGallery('${p.id}')">
                    <div class="absolute inset-0 flex items-center justify-center opacity-30 pointer-events-none">
                        <span class="text-white font-black text-xs tracking-[0.2em] select-none">PR√ìXIMAMENTE</span>
                    </div>
                    <div class="gallery-overlay">
                        <span class="gallery-id">${p.id}</span>
                        <h3 class="gallery-title">${p.name}</h3>
                        <span class="gallery-loc"><i data-lucide="map-pin" class="w-3 h-3"></i> ${p.ubicacion}</span>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function renderCarouselView(list) {
            const container = document.getElementById('carousel-info-content');
            const listWrapper = document.getElementById('list-view-wrapper');
            const carouselWrapper = document.getElementById('carousel-view-wrapper');
            const galleryWrapper = document.getElementById('gallery-view-wrapper');
            
            listWrapper.classList.add('hidden');
            galleryWrapper.classList.add('hidden');
            carouselWrapper.style.display = 'block';
            carouselWrapper.classList.remove('hidden'); 

            if(list.length === 0) {
                container.innerHTML = "SYSTEM ERROR: NO DATA";
                return;
            }
            if(currentCarouselIdx >= list.length) currentCarouselIdx = 0;
            if(currentCarouselIdx < 0) currentCarouselIdx = list.length - 1;

            currentImageIdx = 1;
            updateCarouselImageState();

            const p = list[currentCarouselIdx];
            const cleanRol = p.rol.replace(/\s*\(.*?\)\s*/g, '').trim();

            const infoHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <span class="font-mono text-cyan-400 text-sm tracking-widest font-bold">PROYECTO ID: ${p.id}</span>
                        <div class="flex gap-2">
                             <button class="p-1 border border-gray-500/30 rounded hover:border-cyan-400 text-gray-400 hover:text-cyan-400 transition" onclick="prevProject()"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                             <button class="p-1 border border-gray-500/30 rounded hover:border-cyan-400 text-gray-400 hover:text-cyan-400 transition" onclick="nextProject()"><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-black mt-2 leading-tight" style="color:var(--text-main)">${p.name}</h2>
                    <div class="flex items-center gap-2 mt-2 text-sm" style="color:var(--text-muted)">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> ${p.ubicacion}
                        <span class="opacity-50">|</span>
                        <span>${p.year}</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><span class="field-label">ROL CLAVE</span><p class="field-value" style="color:var(--text-main)">${cleanRol}</p></div>
                    <div><span class="field-label">FASE</span><p class="field-value">${p.fase}</p></div>
                    <div class="col-span-2"><span class="field-label">DESAF√çO T√âCNICO</span><p class="field-value">${p.desafio}</p></div>
                    <div class="col-span-2"><span class="field-label">STACK TECNOL√ìGICO</span><p class="field-value font-mono text-xs text-cyan-400">${p.software}</p></div>
                </div>
                
                <div class="mt-auto pt-4 border-t border-gray-800 flex justify-between items-center">
                    <span class="text-xs font-mono" style="color:var(--text-muted)">INDEX: ${currentCarouselIdx + 1}/${list.length}</span>
                    <button class="btn-tech-primary px-4 py-2 text-xs flex items-center gap-2" onclick="openGallery('${p.id}')"><i data-lucide="maximize"></i> EXPANDIR DETALLES</button>
                </div>
            `;
            container.innerHTML = infoHTML;
            lucide.createIcons();
        }

        function updateStatusBar() {
            const bar = document.getElementById('status-bar-container');
            let msg = ">> ESTADO: ";
            if (isTop5Active) {
                msg += "FILTRO ACTIVO: TOP 5 PROYECTOS DESTACADOS";
            } else {
                const filters = [];
                if(currentFilters.fase !== 'all') filters.push(`FASE: ${currentFilters.fase}`);
                if(currentFilters.type !== 'all') filters.push(`TIPO: ${currentFilters.type}`);
                if(currentFilters.disc !== 'all') filters.push(`DISC: ${currentFilters.disc}`);
                if(currentFilters.year !== 'all') filters.push(`A√ëO: ${currentFilters.year}`);
                if(filters.length > 0) msg += "FILTRO: " + filters.join(" + ");
                else msg += "BASE DE DATOS ONLINE";
            }
            const viewNames = {list: "LISTA", carousel: "FICHA", gallery: "GALER√çA"};
            msg += ` | VISTA: ${viewNames[currentViewMode]}`;
            bar.innerText = msg;
        }

        window.setProjectView = (sec, mode) => {
            currentViewMode = mode;
            document.querySelectorAll('.view-toggle-wrapper .view-btn').forEach(b => b.classList.remove('active', 'text-cyan-400'));
            const activeBtn = document.querySelector(`.view-toggle-wrapper button[onclick*="${mode}"]`);
            if(activeBtn) { activeBtn.classList.add('active', 'text-cyan-400'); }
            runFilter('proyectos');
        };

        function toggleFilters(section) {
            const panel = document.getElementById(`${section}-filters`);
            const btn = document.getElementById('btn-filter-toggle');
            panel.classList.toggle('hidden');
            btn.classList.toggle('active');
        }

        function toggleTop5() {
            const btn = document.getElementById('btn-top5');
            if (!isTop5Active) {
                isTop5Active = true;
                btn.classList.add('active'); 
                const topIds = ['P63', 'P44', 'P61', 'P15', 'P49']; 
                const filtered = sortedProjects.filter(p => topIds.includes(p.id));
                document.getElementById('search-bar').value = '';
                currentCarouselIdx = 0;
                renderProjects('proyectos', filtered);
            } else {
                isTop5Active = false;
                btn.classList.remove('active');
                clearFilters('proyectos');
            }
            lucide.createIcons();
            updateStatusBar();
        }

        function runFilter(section) {
            if (isTop5Active) {
                isTop5Active = false;
                const btn = document.getElementById('btn-top5');
                btn.classList.remove('active');
            }
            const typeVal = document.getElementById(`${section}-filter-type`).value;
            const discVal = document.getElementById(`${section}-filter-disc`).value;
            const yearVal = document.getElementById(`${section}-filter-year`).value;
            const faseVal = document.getElementById(`${section}-filter-fase`).value;
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            
            const filterBtn = document.getElementById('btn-filter-toggle');
            if(typeVal !== 'all' || discVal !== 'all' || yearVal !== 'all' || faseVal !== 'all') {
                filterBtn.classList.add('active');
            } else {
                const panel = document.getElementById(`${section}-filters`);
                if(panel.classList.contains('hidden')) {
                    filterBtn.classList.remove('active');
                }
            }
            
            currentFilters = { type: typeVal, disc: discVal, year: yearVal, fase: faseVal };

            let filtered = sortedProjects.filter(p => {
                const matchType = typeVal === 'all' || p.tipologia === typeVal;
                const matchDisc = discVal === 'all' || p.disciplinas.includes(discVal);
                const matchYear = yearVal === 'all' || p.year.includes(yearVal);
                const matchFase = faseVal === 'all' || p.fase === faseVal;
                const matchSearch = searchTerm === '' || 
                                    p.name.toLowerCase().includes(searchTerm) ||
                                    p.ubicacion.toLowerCase().includes(searchTerm) ||
                                    p.disciplinas.toLowerCase().includes(searchTerm) ||
                                    p.tipologia.toLowerCase().includes(searchTerm);
                return matchType && matchDisc && matchYear && matchFase && matchSearch;
            });
            currentCarouselIdx = 0; 
            renderProjects(section, filtered);
            updateStatusBar();
        }

        function clearFilters(section) {
            document.getElementById(`${section}-filter-type`).value = 'all';
            document.getElementById(`${section}-filter-disc`).value = 'all';
            document.getElementById(`${section}-filter-year`).value = 'all';
            document.getElementById(`${section}-filter-fase`).value = 'all';
            document.getElementById('search-bar').value = '';
            runFilter(section);
        }

        function updateSort(sec, val) {
            if (val === 'year_asc') sortedProjects.sort((a,b) => parseInt(a.year) - parseInt(b.year));
            else if (val === 'name_asc') sortedProjects.sort((a,b) => a.name.localeCompare(b.name));
            else sortedProjects.sort((a,b) => parseInt(a.staticId) - parseInt(b.staticId)); 
            runFilter(sec);
        }

        window.nextProject = () => { currentCarouselIdx++; renderCarouselView(window.currentFilteredList); };
        window.prevProject = () => { currentCarouselIdx--; renderCarouselView(window.currentFilteredList); };

        window.navigateCarouselImage = (dir) => {
            currentImageIdx += dir;
            if(currentImageIdx > 3) currentImageIdx = 1; 
            if(currentImageIdx < 1) currentImageIdx = 3;
            updateCarouselImageState();
        };

        function updateCarouselImageState() {
            const imgText = document.getElementById('carousel-img-text');
            const countText = document.getElementById('carousel-img-count');
            const bg = document.getElementById('carousel-image-bg');
            const p = window.currentFilteredList[currentCarouselIdx];
            
            const ruta = `img/${p.id} ${p.name}/${currentImageIdx}.jpg`;
            imgText.innerText = `IMG_0${currentImageIdx}`;
            countText.innerText = `${currentImageIdx} / 3`;
            const opacity = 0.5 + (currentImageIdx * 0.1);
            bg.style.background = `linear-gradient(45deg, #0f172a, rgba(34, 211, 238, ${opacity * 0.1})), url('${ruta}') center/cover no-repeat`;
        }

        function openGallery(pid) {
            const idx = sortedProjects.findIndex(p => p.id === pid);
            if(idx === -1) return;
            currentIdx = idx; updateModal();
            const modal = document.getElementById('gallery-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex'); // Centrado corregido
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
                modal.querySelector('.modal-content').classList.add('scale-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        }

        function updateModal() {
            const p = sortedProjects[currentIdx];
            const ruta = `img/${p.id} ${p.name}/${currentImageIdx}.jpg`;
            document.getElementById('modal-title-container').innerHTML = `
                <span class="font-mono text-cyan-400 font-bold">${p.id}</span>
                <span class="text-xl font-bold uppercase" style="color:var(--text-main)">${p.name}</span>
            `;
            document.getElementById('modal-img-bg').style.backgroundImage = `url('${ruta}')`;
            document.getElementById('modal-counter').innerText = `${currentImageIdx} / 3`;
        }

        function closeGallery() { 
            const modal = document.getElementById('gallery-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.remove('scale-100');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = ''; 
            }, 300);
        }

        function navigateProject(dir) { currentIdx += dir; if (currentIdx < 0) currentIdx = sortedProjects.length - 1; if (currentIdx >= sortedProjects.length) currentIdx = 0; currentImageIdx = 1; updateModal(); }
        function navigateImage(dir) { 
             currentImageIdx += dir; 
             if(currentImageIdx > 3) currentImageIdx = 1; 
             if(currentImageIdx < 1) currentImageIdx = 3; 
             updateModal(); 
        }
        
        window.scrollToCard = (id) => { 
            if(currentViewMode !== 'carousel') {
               setProjectView('proyectos', 'carousel');
            }
            const idx = window.currentFilteredList.findIndex(p => p.id === id);
            if(idx !== -1) {
                currentCarouselIdx = idx;
                renderCarouselView(window.currentFilteredList);
                document.getElementById('proyectos').scrollIntoView({behavior:'smooth'});
            }
        };

        function toggleChat() {
            const chat = document.getElementById('chat-window');
            chat.classList.toggle('hidden');
            if(!chat.classList.contains('hidden') && document.getElementById('chat-messages').innerHTML === '') {
                initChat();
            }
        }

        function initChat() {
            chatHistory = [];
            addBotMessage("SYSTEM_READY. Soy el asistente virtual de Said. Seleccione una opci√≥n:");
            renderChatOptions(['M√ÅSTER BIM+IA', 'Ver Top 5', 'Tengo un Proyecto', 'Contacto']);
        }

        function addBotMessage(text) {
            const div = document.getElementById('chat-messages');
            div.innerHTML += `<div class="bot-msg p-2 mb-2 text-xs animate-pulse">Computing...</div>`;
            div.scrollTop = div.scrollHeight;
            setTimeout(() => {
                div.lastElementChild.remove();
                div.innerHTML += `<div class="bot-msg p-2 mb-2 text-xs font-mono"><strong>> AI:</strong> ${text}</div>`;
                div.scrollTop = div.scrollHeight;
            }, 600);
        }

        function renderChatOptions(options) {
            const div = document.getElementById('chat-options');
            div.innerHTML = options.map(opt => 
                `<button class="text-left text-xs font-mono text-cyan-400 hover:bg-cyan-400/10 p-1 border border-transparent hover:border-cyan-400/30 rounded transition" onclick="handleChatOption('${opt}')">> ${opt}</button>`
            ).join('');
        }

        function handleChatOption(opt) {
            const div = document.getElementById('chat-messages');
            div.innerHTML += `<div class="user-msg p-2 mb-2 text-xs font-mono">${opt}</div>`;
            div.scrollTop = div.scrollHeight;
            chatHistory.push(document.getElementById('chat-options').innerHTML);

            if(opt.includes('Top 5')) {
                addBotMessage("Recuperando registros destacados:\n1. Central de Mezclas\n2. Hospital GZ\n3. Naomi\n4. Santa Luc√≠a\n5. Tren Ligero");
                renderChatOptions(['Habilidades', 'Volver']);
            } else if (opt.includes('M√ÅSTER')) {
                addBotMessage("El M√°ster en BIM + IA se enfoca en automatizaci√≥n (Python/Dynamo) y optimizaci√≥n de procesos AECO.");
                renderChatOptions(['Volver']);
            } else {
                 addBotMessage("Comando recibido. ¬øDesea m√°s informaci√≥n?");
                 renderChatOptions(['Ver Top 5', 'Contacto', 'Volver']);
            }
        }

        function handleInput() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            const div = document.getElementById('chat-messages');
            div.innerHTML += `<div class="user-msg p-2 mb-2 text-xs font-mono">${text}</div>`;
            input.value = '';
            div.scrollTop = div.scrollHeight;
            addBotMessage("Procesando consulta en lenguaje natural... (Simulaci√≥n: Respuesta gen√©rica activada).");
        }
        function handleEnter(e) { if(e.key === 'Enter') handleInput(); }
        function resetChat() { document.getElementById('chat-messages').innerHTML=''; initChat(); }
        function goBack() { 
            if(chatHistory.length > 0) {
                document.getElementById('chat-options').innerHTML = chatHistory.pop();
            }
        }
        function triggerAssistantSpecial() {
             const chat = document.getElementById('chat-window');
             if(chat.classList.contains('hidden')) toggleChat();
             addBotMessage("¬°Alerta de Sistema! La integraci√≥n de IA permite reducir tiempos de modelado hasta un 40%.");
        }

        function renderSoftware() {
             const softData = [
                 { name: "ACC / BIM 360", icon: "cloud", desc: "Gesti√≥n Documental" },
                 { name: "AutoCAD", icon: "pen-tool", desc: "Dibujo 2D" },
                 { name: "Dynamo", icon: "cpu", desc: "Automatizaci√≥n" },
                 { name: "Gemini AI", icon: "sparkles", desc: "Asistente de Inteligencia Artificial" }, 
                 { name: "Monday", icon: "layout-list", desc: "Gesti√≥n Tareas" },
                 { name: "Navisworks", icon: "crosshair", desc: "Interferencias" },
                 { name: "ReCap", icon: "scan", desc: "Nubes Puntos" },
                 { name: "Revit", icon: "layers", desc: "Modelado BIM" },
                 { name: "Twinmotion", icon: "image", desc: "Render Real-Time" }
             ];
            document.getElementById('software-list').innerHTML = softData.map(s => `
                <div class="tech-card p-4 flex flex-col items-center justify-center text-center hover:bg-gray-800/10 transition">
                    <i data-lucide="${s.icon}" class="text-cyan-400 mb-2 w-8 h-8"></i>
                    <h4 class="font-bold text-sm" style="color:var(--text-main)">${s.name}</h4>
                    <p class="text-[0.65rem] font-mono mt-1" style="color:var(--text-muted)">${s.desc}</p>
                </div>
            `).join('');
        }

        function generateTypologyStats() {
            const counts = {}; 
            let total = 0;
            let countedCM = false;      
            let countedCovid = false;   

            sortedProjects.forEach(p => {
                let shouldCount = true;
                if (p.name.includes("Central de Mezclas")) { if (countedCM) shouldCount = false; else countedCM = true; }
                else if (p.name.includes("M√≥dulo COVID")) { if (countedCovid) shouldCount = false; else countedCovid = true; }
                if (shouldCount) {
                    if(!counts[p.tipologia]) counts[p.tipologia] = 0;
                    counts[p.tipologia]++;
                    total++;
                }
            });
            const sorted = Object.entries(counts).map(([t,c]) => ({type:t, pct:Math.round((c/total)*100)})).sort((a,b)=>b.pct-a.pct);
            document.getElementById('typology-grid').innerHTML = sorted.map(t => 
                `<div class="border bg-white/5 px-3 py-2 rounded text-xs font-mono flex justify-between items-center min-w-[140px] flex-grow" style="border-color:var(--border-color)">
                    <span style="color:var(--text-muted)">${t.type}</span> <span class="text-cyan-400 font-bold">${t.pct}%</span>
                </div>`
            ).join('');
        }

        function renderTech() {
             const data = [{t:"AS-BUILT 6D", d:"Documentaci√≥n de condiciones existentes."},{t:"COSTOS 5D", d:"Extracci√≥n de QTO"},{t:"COORDINACI√ìN MEP", d:"Gesti√≥n proactiva de conflictos"},{t:"AUTOMATIZACI√ìN", d:"Dynamo + Python"},{t:"GESTI√ìN CDE", d:"BIM 360 / ACC"},{t:"SCAN-TO-BIM", d:"Nubes de Puntos"}];
            document.getElementById('tech-grid').innerHTML = data.map(x=> `
                <div class="bg-white/5 border p-4 rounded hover:border-cyan-400 transition cursor-default" style="border-color:var(--border-color)">
                    <h4 class="font-black text-sm mb-1 uppercase" style="color:var(--text-main)">${x.t}</h4>
                    <p class="text-xs" style="color:var(--text-muted)">${x.d}</p>
                </div>
            `).join('');
        }

        function populateFilterOptions() {
             const fases = [...new Set(sortedProjects.map(p => p.fase))].sort();
             const types = [...new Set(sortedProjects.map(p => p.tipologia))].sort();
             const discs = [...new Set(sortedProjects.map(p => p.disciplinas.split('‚Ä¢')[0].trim()))].sort();
             const years = [...new Set(sortedProjects.map(p => p.year.split('-')[0]))].sort().reverse();
             const f = (id, arr) => arr.forEach(v => document.getElementById(id).innerHTML += `<option value="${v}">${v}</option>`);
             f('proyectos-filter-fase', fases); f('proyectos-filter-type', types); 
             f('proyectos-filter-disc', discs); f('proyectos-filter-year', years);
        }

        function renderD3Map() {
            const container = document.getElementById('d3-map-svg-container'); 
            const w = container.clientWidth; const h = 500;
            svg = d3.select("#map-svg").attr("width", w).attr("height", h);
            const proj = d3.geoMercator().center([-96, 26]).scale(w * 0.9).translate([w/2, h/2]); 
            const path = d3.geoPath().projection(proj); 
            g = svg.append("g");

            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(data => {
                g.selectAll("path").data(topojson.feature(data, data.objects.countries).features).enter().append("path").attr("class", "country").attr("d", path);
                const cities = {}; 
                sortedProjects.forEach(p => { 
                    if(p.coords && !p.isConfidential) { 
                        const name = p.ubicacion.split(',')[0].trim(); 
                        if(!cities[name]) cities[name] = {name:name, coords:p.coords, projects:[], hasObra:false, isInt: p.ubicacion.includes("USA")||p.ubicacion.includes("Jamaica")}; 
                        if(p.fase==='Obra') cities[name].hasObra = true; 
                        cities[name].projects.push(p); 
                    } 
                });
                const cityData = Object.values(cities).map(c => ({...c, color: c.isInt?'#EAB308':(c.hasObra?'#22c55e':'#3b82f6')}));
                g.selectAll("circle").data(cityData).enter().append("circle").attr("class","city-marker")
                  .attr("cx",d=>proj(d.coords)[0]).attr("cy",d=>proj(d.coords)[1]).attr("r",4).attr("fill",d=>d.color)
                  .on("mouseenter", (e,d) => { 
                      clearTimeout(hideTimeout); 
                      const rows = d.projects.sort((a,b) => parseInt(a.staticId) - parseInt(b.staticId)).map(p=>`
                        <div class="tooltip-row" onclick="scrollToCard('${p.id}')">
                            <span class="tooltip-pid" style="color:${d.color}">P.${p.staticId}</span>
                            <div class="tooltip-info"><span class="tooltip-name">${p.name}</span><span class="tooltip-meta">${p.tipologia}</span></div>
                        </div>`
                      ).join(''); 
                      let gridClass = '';
                      if(d.projects.length > 20) gridClass = 'tooltip-cols-3'; else if (d.projects.length > 10) gridClass = 'tooltip-cols-2';
                      tooltipElement.innerHTML = `<div class="tooltip-header" style="border-left: 3px solid ${d.color}; color:${d.color}">${d.name} <span style="font-size:0.6rem; opacity:0.7">${d.projects.length} PROY.</span></div><div class="tooltip-content ${gridClass}">${rows}</div>`; 
                      tooltipElement.style.opacity=1; tooltipElement.style.visibility='visible'; tooltipElement.style.width = 'auto'; 
                      const rect = tooltipElement.getBoundingClientRect(); 
                      let top = e.clientY - rect.height - 15; let left = e.clientX - rect.width/2;
                      if(top < 0) top = e.clientY + 15; if(left < 10) left = 10; if(left + rect.width > window.innerWidth) left = window.innerWidth - rect.width - 10;
                      tooltipElement.style.top = top + 'px'; tooltipElement.style.left = left + 'px'; 
                  })
                  .on("mouseleave", () => { hideTimeout = setTimeout(() => { tooltipElement.style.opacity=0; tooltipElement.style.visibility='hidden'; }, 1500); });
                document.getElementById('stat-count-projects').innerText = sortedProjects.length;
                const labels = [{n:"M√âXICO",c:[-103,24.5]},{n:"USA",c:[-100,32]},{n:"JAM",c:[-77.5,18]}];
                g.selectAll(".country-label").data(labels).enter().append("text").attr("class","country-label-text").attr("x",d=>proj(d.c)[0]).attr("y",d=>proj(d.c)[1]).text(d=>d.n).attr("text-anchor","middle");
            }).catch(err => console.log("Error cargando mapa:", err));
            const zoom = d3.zoom().scaleExtent([1,8]).on("zoom", e => { g.attr("transform", e.transform); g.selectAll("circle").attr("r", 4/e.transform.k); g.selectAll(".country-label-text").attr("font-size", (14/e.transform.k)+"px"); });
            svg.call(zoom); 
            window.handleResetZoom = () => svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
        }

        function filterMap(category) {
            const circles = d3.selectAll('.city-marker');
            let visibleProjects = 0;
            circles.each(function(d) {
                let isVisible = false;
                if (category === 'all') isVisible = true;
                else if (category === 'Obra' && d.hasObra) isVisible = true;
                else if (category === 'Oficina' && !d.hasObra && !d.isInt) isVisible = true;
                else if (category === 'Internacional' && d.isInt) isVisible = true;
                d3.select(this).transition().duration(300).attr('r', isVisible ? 4 : 0).attr('opacity', isVisible ? 1 : 0);
                if(isVisible) visibleProjects += d.projects.length;
            });
            document.getElementById('stat-count-projects').innerText = visibleProjects;
            const resetBtn = document.getElementById('reset-map-btn');
            if(category === 'all') resetBtn.style.display = 'none'; else resetBtn.style.display = 'block';
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>